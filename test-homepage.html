<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Job Portal Test - Homepage</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .job-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
  .job-card h3 { margin: 0 0 10px 0; color: #333; }
  .job-card p { margin: 5px 0; }
  .job-card button { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
  .job-card button:hover { background: #0056b3; }
  .filter-container { background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
  .filter-container input { margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  .filter-container button { margin: 5px; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
  .filter-container button:first-of-type { background: #28a745; color: white; }
  .filter-container button:last-of-type { background: #6c757d; color: white; }
</style>
</head>
<body>

<h1>Job Portal - Latest Jobs</h1>

<div class="filter-container">
  <input type="text" id="jobTitle" placeholder="Job Title">
  <input type="text" id="location" placeholder="Location">
  <input type="text" id="skills" placeholder="Skills (comma separated)">
  <input type="number" id="minSalary" placeholder="Min Salary">
  <input type="number" id="maxSalary" placeholder="Max Salary">
  <button id="applyFilters">Apply Filters</button>
  <button id="clearFilters">Clear</button>
</div>

<div id="job-list" class="job-list"></div>
<div id="pagination" class="pagination-container"></div>

<script>
const jobListEl = document.getElementById('job-list');
const paginationEl = document.getElementById('pagination');
const jobTitleInput = document.getElementById('jobTitle');
const locationInput = document.getElementById('location');
const skillsInput = document.getElementById('skills');
const minSalaryInput = document.getElementById('minSalary');
const maxSalaryInput = document.getElementById('maxSalary');

let currentPage = 1;
let totalPages = 1;
let jobsData = [];

// Fetch jobs from backend
async function fetchJobs(page = 1) {
  try {
    const res = await fetch(`http://localhost:5001/jobs?page=${page}&limit=10`);
    const data = await res.json();
    jobsData = data.jobs || [];
    totalPages = Math.ceil(data.total / 10) || 1;
    renderJobs();
    renderPagination();
  } catch (err) {
    console.error("Error fetching jobs:", err);
    jobListEl.innerHTML = "<p>Error loading jobs</p>";
  }
}

// Render job cards
function renderJobs() {
  const filteredJobs = jobsData.filter(job => {
    const titleMatch = job.job_position.toLowerCase().includes(jobTitleInput.value.toLowerCase());
    const locationMatch = job.location.toLowerCase().includes(locationInput.value.toLowerCase());

    // Handle skills_required - it could be JSON string or array
    let jobSkills = [];
    try {
      jobSkills = Array.isArray(job.skills_required) 
        ? job.skills_required 
        : JSON.parse(job.skills_required || '[]');
    } catch (e) {
      jobSkills = (job.skills_required || '').split(',').map(s => s.trim()).filter(s => s);
    }

    const skillsMatch = skillsInput.value === '' || skillsInput.value
      .split(',')
      .every(s => jobSkills.some(skill => skill.toLowerCase().includes(s.trim().toLowerCase())));

    const minSalaryMatch = minSalaryInput.value === '' || job.monthly_salary >= parseInt(minSalaryInput.value);
    const maxSalaryMatch = maxSalaryInput.value === '' || job.monthly_salary <= parseInt(maxSalaryInput.value);

    return titleMatch && locationMatch && skillsMatch && minSalaryMatch && maxSalaryMatch;
  });

  jobListEl.innerHTML = filteredJobs.length === 0
    ? "<p>No jobs found</p>"
    : filteredJobs.map(job => {
      // Handle skills display
      let skillsDisplay = '';
      try {
        const skills = Array.isArray(job.skills_required) 
          ? job.skills_required 
          : JSON.parse(job.skills_required || '[]');
        skillsDisplay = Array.isArray(skills) ? skills.join(', ') : skills;
      } catch (e) {
        skillsDisplay = job.skills_required || 'Not specified';
      }

      return `
      <div class="job-card">
        ${job.logo_url ? `<img src="${job.logo_url}" alt="${job.company_name} logo" onerror="this.style.display='none'" style="max-width: 60px; float: right;">` : ''}
        <div>
          <h3>${job.job_position}</h3>
          <p><strong>Company:</strong> ${job.company_name}</p>
          <p><strong>Salary:</strong> â‚¹${job.monthly_salary || 'Not specified'}</p>
          <p><strong>Location:</strong> ${job.location}</p>
          <p><strong>Skills:</strong> ${skillsDisplay}</p>
          <p><strong>Posted:</strong> ${new Date(job.createdAt).toLocaleDateString()}</p>
        </div>
        <button onclick="viewJob(${job.id})">View Details</button>
      </div>
    `;
    }).join('');
}

// Pagination
function renderPagination() {
  let html = '';
  for (let i = 1; i <= totalPages; i++) {
    html += `<button style="margin: 0 5px; padding: 5px 10px; ${i === currentPage ? 'background: #007bff; color: white;' : 'background: #f8f9fa;'}" onclick="goToPage(${i})">${i}</button>`;
  }
  paginationEl.innerHTML = html;
}

function goToPage(page) {
  currentPage = page;
  fetchJobs(page);
}

// Filter and clear button listeners
document.getElementById('applyFilters').addEventListener('click', () => {
  currentPage = 1;
  renderJobs();
  renderPagination();
});

document.getElementById('clearFilters').addEventListener('click', () => {
  jobTitleInput.value = '';
  locationInput.value = '';
  skillsInput.value = '';
  minSalaryInput.value = '';
  maxSalaryInput.value = '';
  currentPage = 1;
  renderJobs();
  renderPagination();
});

// View job details
function viewJob(id) {
  alert(`Viewing job details for job ID: ${id}\nIn a real application, this would navigate to a job details page.`);
}

// Initial fetch
fetchJobs();
</script>

</body>
</html>